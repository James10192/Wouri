# Conversation Schema

Data structure for conversations between users and Wouri Bot.

---

## Base Conversation Object

```typescript
interface Conversation {
  id: string;                  // UUID - Unique conversation identifier
  wa_id: string;               // WhatsApp user ID (e.g., "1234567890")
  message_id: string;          // WhatsApp message ID
  message_type: MessageType;   // "text" | "audio" | "image"
  user_message: string;        // User's question or message content
  bot_response: string;        // Bot's generated response
  language: Language;          // "fr" | "dioula" | "baoulé" | "en"
  region: string | null;       // User's region (e.g., "Bouaké", "Abidjan")
  feedback_count: number;      // Number of feedback entries (default: 0)
  average_rating: number | null; // Average rating from feedback (1-5, 2 decimals)
  model_used: string | null;   // Groq model name (e.g., "llama-3.3-70b-versatile")
  tokens_used: number | null;  // Total tokens consumed in LLM call
  response_time_ms: number | null; // Response time in milliseconds
  created_at: string;          // ISO 8601 timestamp (e.g., "2026-01-10T10:30:00Z")
}
```

## TypeScript Types

```typescript
// Message types
type MessageType = "text" | "audio" | "image";

// Supported languages
type Language = "fr" | "dioula" | "baoulé" | "en";

// Zod schema for validation
import { z } from "zod";

export const conversationSchema = z.object({
  id: z.string().uuid(),
  wa_id: z.string().min(10),
  message_id: z.string().min(1),
  message_type: z.enum(["text", "audio", "image"]),
  user_message: z.string().min(1),
  bot_response: z.string().min(1),
  language: z.enum(["fr", "dioula", "baoulé", "en"]),
  region: z.string().nullable(),
  feedback_count: z.number().int().min(0).default(0),
  average_rating: z.number().min(1).max(5).nullable(),
  model_used: z.string().nullable(),
  tokens_used: z.number().int().nullable(),
  response_time_ms: z.number().int().nullable(),
  created_at: z.string().datetime(),
});

export type Conversation = z.infer<typeof conversationSchema>;
```

---

## Conversation Detail Object

Conversation with related feedback entries.

```typescript
interface ConversationDetail extends Conversation {
  feedback: Feedback[];  // Array of feedback entries
}
```

**Example**:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "wa_id": "1234567890",
  "message_id": "wamid.HBgLMTIzNDU2Nzg5MAVReplyMessageId",
  "message_type": "text",
  "user_message": "Quand planter le maïs à Bouaké?",
  "bot_response": "Le maïs se plante à Bouaké entre avril et juin pendant la saison des pluies. Température idéale: 25-30°C. Sol bien drainé requis.",
  "language": "fr",
  "region": "Bouaké",
  "feedback_count": 2,
  "average_rating": 4.5,
  "model_used": "llama-3.3-70b-versatile",
  "tokens_used": 450,
  "response_time_ms": 1200,
  "created_at": "2026-01-10T10:30:00Z",
  "feedback": [
    {
      "id": "770e8400-e29b-41d4-a716-446655440000",
      "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
      "wa_id": "1234567890",
      "rating": 5,
      "comment": "Excellent advice on maize planting!",
      "is_embedded": true,
      "created_at": "2026-01-10T11:00:00Z",
      "updated_at": "2026-01-10T11:00:00Z"
    },
    {
      "id": "880e8400-e29b-41d4-a716-446655440000",
      "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
      "wa_id": "1234567890",
      "rating": 4,
      "comment": "Very helpful information",
      "is_embedded": true,
      "created_at": "2026-01-10T12:00:00Z",
      "updated_at": "2026-01-10T12:00:00Z"
    }
  ]
}
```

---

## Paginated Conversation List

Response format for GET /admin/conversations.

```typescript
interface ConversationList {
  conversations: Conversation[];
  nextCursor: string | null;  // UUID for next page
  hasMore: boolean;            // True if more results available
  total: number;               // Total conversations in current page
}
```

**Example**:
```json
{
  "conversations": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "wa_id": "1234567890",
      "message_type": "text",
      "user_message": "Quand planter le maïs?",
      "bot_response": "Le maïs se plante entre avril et juin...",
      "language": "fr",
      "region": "Bouaké",
      "feedback_count": 2,
      "average_rating": 4.5,
      "created_at": "2026-01-10T10:30:00Z"
    }
  ],
  "nextCursor": "660e8400-e29b-41d4-a716-446655440000",
  "hasMore": true,
  "total": 50
}
```

---

## Field Descriptions

### Core Fields

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `id` | UUID | No | Unique conversation identifier generated by database |
| `wa_id` | string | No | WhatsApp user ID (phone number without +) |
| `message_id` | string | No | WhatsApp message ID for tracing |
| `message_type` | enum | No | Type of incoming message: text, audio, image |
| `user_message` | string | No | User's question or message content (transcribed if audio) |
| `bot_response` | string | No | Bot's generated response via RAG pipeline |
| `language` | enum | No | Conversation language (fr, dioula, baoulé, en) |
| `region` | string | Yes | User's geographic region (e.g., "Bouaké", "Abidjan") |
| `created_at` | datetime | No | Timestamp when conversation was created (ISO 8601) |

### Analytics Fields

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `feedback_count` | integer | No | Number of feedback entries for this conversation |
| `average_rating` | decimal | Yes | Average rating from all feedback (1.00-5.00) |
| `model_used` | string | Yes | Groq model name used for generation |
| `tokens_used` | integer | Yes | Total tokens consumed (prompt + completion) |
| `response_time_ms` | integer | Yes | End-to-end response time in milliseconds |

---

## Message Types

### Text Messages
```json
{
  "message_type": "text",
  "user_message": "Quand planter le maïs à Bouaké?"
}
```
- Direct text input from user
- Most common message type
- No preprocessing required

### Audio Messages
```json
{
  "message_type": "audio",
  "user_message": "Quand planter le maïs à Bouaké?" // Transcribed via Groq Whisper
}
```
- WhatsApp voice message
- Transcribed to text via Groq Whisper API (free)
- `user_message` contains transcription

### Image Messages
```json
{
  "message_type": "image",
  "user_message": "Plant disease identification request" // Description or extracted text
}
```
- WhatsApp photo message
- Analyzed via LLaVA vision model (Groq)
- `user_message` contains description or extracted text

---

## Language Support

| Language | Code | Speakers in CI | Notes |
|----------|------|----------------|-------|
| Français | `fr` | ~10M (official) | Primary language |
| Dioula | `dioula` | ~5M (north) | Bambara variant |
| Baoulé | `baoulé` | ~4M (center) | Akan language |
| English | `en` | Limited | Documentation only |

---

## Region Values

Common regions in Côte d'Ivoire:

- Abidjan (economic capital)
- Bouaké (center)
- Daloa (west)
- Yamoussoukro (political capital)
- Korhogo (north)
- San-Pédro (southwest coast)
- Man (west mountains)

**Note**: Region is optional and may be null for users who haven't shared location.

---

## Model Names

Groq models used for generation:

| Model | Code | Best For |
|-------|------|----------|
| Llama 3.3 70B | `llama-3.3-70b-versatile` | RAG responses (recommended) |
| Llama 3.1 8B | `llama-3.1-8b-instant` | Ultra-fast responses |
| Mixtral 8x7B | `mixtral-8x7b-32768` | Multilingual support |

---

## Analytics Metrics

### feedback_count
- Incremented automatically via `update_conversation_feedback_stats()` SQL function
- Used to identify popular/problematic conversations
- Range: 0 to unlimited

### average_rating
- Calculated from all feedback ratings for this conversation
- Range: 1.00 to 5.00 (2 decimal precision)
- Null if no ratings submitted
- Updated via SQL trigger on feedback insertion

### tokens_used
- Sum of prompt tokens + completion tokens
- Tracked for cost monitoring (Groq is free, but limits exist)
- Typical range: 200-1000 tokens per conversation

### response_time_ms
- Measures end-to-end latency:
  1. Receive WhatsApp webhook
  2. RAG pipeline (embedding + vector search + LLM)
  3. Send response via WhatsApp API
- Typical range: 800-2000ms
- Used for performance monitoring

---

## Database Schema

```sql
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wa_id TEXT NOT NULL,
  message_id TEXT NOT NULL UNIQUE,
  message_type TEXT NOT NULL CHECK (message_type IN ('text', 'audio', 'image')),
  user_message TEXT NOT NULL,
  bot_response TEXT NOT NULL,
  language TEXT NOT NULL DEFAULT 'fr',
  region TEXT,
  feedback_count INTEGER DEFAULT 0,
  average_rating DECIMAL(3,2),
  model_used TEXT,
  tokens_used INTEGER,
  response_time_ms INTEGER,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- Indexes
CREATE INDEX conversations_wa_id_idx ON conversations(wa_id);
CREATE INDEX conversations_created_at_idx ON conversations(created_at DESC);
CREATE INDEX conversations_language_idx ON conversations(language);
```

---

## Related Schemas

- [Feedback Schema](./feedback.md) - Feedback entries linked to conversations
- [Translation Schema](./translation.md) - Multilingual translation database
- [Knowledge Schema](./knowledge.md) - RAG document database

---

## Validation Rules

### Required Fields
- `wa_id`: Must be 10+ characters
- `message_id`: Must be non-empty string
- `user_message`: Must be non-empty string
- `bot_response`: Must be non-empty string
- `language`: Must be one of: fr, dioula, baoulé, en

### Optional Fields
- `region`: Any string or null
- `model_used`: Any string or null
- `tokens_used`: Positive integer or null
- `response_time_ms`: Positive integer or null

### Analytics Fields
- `feedback_count`: Auto-incremented, read-only from API
- `average_rating`: Auto-calculated, read-only from API

---

## Query Examples

### Get conversations for specific user
```typescript
const response = await adminFetch('/admin/conversations?wa_id=1234567890&limit=50');
```

### Get French conversations only
```typescript
const response = await adminFetch('/admin/conversations?language=fr&limit=100');
```

### Get conversation with all feedback
```typescript
const response = await adminFetch('/admin/conversations/550e8400-e29b-41d4-a716-446655440000');
```

---

## Best Practices

### Reading Conversations
- ✅ Use cursor-based pagination for large datasets
- ✅ Filter by `language` or `wa_id` to reduce result size
- ✅ Check `feedback_count > 0` to find reviewed conversations
- ✅ Sort by `created_at DESC` to see recent conversations

### Analytics
- ✅ `average_rating < 3.0` indicates poor response quality
- ✅ `response_time_ms > 3000` indicates performance issues
- ✅ `tokens_used > 1000` indicates verbose responses
- ✅ `feedback_count = 0` indicates no admin review yet

### Performance
- ✅ Use `limit` parameter (default: 50, max: 100)
- ✅ Use `cursor` for pagination instead of offset
- ✅ Avoid fetching all conversations at once
