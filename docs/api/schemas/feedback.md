# Feedback Schema

Data structure for admin feedback used in the RAG improvement loop.

---

## Base Feedback Object

```typescript
interface Feedback {
  id: string;                    // UUID - Unique feedback identifier
  conversation_id: string;       // UUID - Associated conversation ID
  wa_id: string;                 // WhatsApp user ID
  rating: number | null;         // Quality rating (1-5)
  comment: string | null;        // Admin feedback text (max 2000 chars)
  is_embedded: boolean;          // True if comment embedded in vector DB
  created_at: string;            // ISO 8601 timestamp
  updated_at: string;            // ISO 8601 timestamp
}
```

## TypeScript Types

```typescript
// Zod schema for validation
import { z } from "zod";

export const feedbackSchema = z.object({
  id: z.string().uuid(),
  conversation_id: z.string().uuid(),
  wa_id: z.string().min(10),
  rating: z.number().int().min(1).max(5).nullable(),
  comment: z.string().max(2000).nullable(),
  is_embedded: z.boolean().default(false),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
});

export type Feedback = z.infer<typeof feedbackSchema>;

// Create feedback request
export const feedbackCreateSchema = z.object({
  conversation_id: z.string().uuid(),
  rating: z.number().int().min(1).max(5).optional(),
  comment: z.string().max(2000).optional(),
  embed_immediately: z.boolean().default(true),
});

export type FeedbackCreate = z.infer<typeof feedbackCreateSchema>;
```

---

## Example Feedback Object

```json
{
  "id": "770e8400-e29b-41d4-a716-446655440000",
  "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
  "wa_id": "1234567890",
  "rating": 5,
  "comment": "Excellent advice on maize planting periods! Very accurate for Bouak√© region. Temperature ranges and timing recommendations are spot-on.",
  "is_embedded": true,
  "created_at": "2026-01-10T12:00:00Z",
  "updated_at": "2026-01-10T12:00:00Z"
}
```

---

## Feedback List Response

```typescript
interface FeedbackList {
  feedback: Feedback[];
}
```

**Example**:
```json
{
  "feedback": [
    {
      "id": "770e8400-e29b-41d4-a716-446655440000",
      "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
      "wa_id": "1234567890",
      "rating": 5,
      "comment": "Excellent advice on maize planting!",
      "is_embedded": true,
      "created_at": "2026-01-10T12:00:00Z",
      "updated_at": "2026-01-10T12:00:00Z"
    },
    {
      "id": "880e8400-e29b-41d4-a716-446655440000",
      "conversation_id": "660e8400-e29b-41d4-a716-446655440000",
      "wa_id": "9876543210",
      "rating": 4,
      "comment": "Very helpful information",
      "is_embedded": true,
      "created_at": "2026-01-10T13:00:00Z",
      "updated_at": "2026-01-10T13:00:00Z"
    }
  ]
}
```

---

## Field Descriptions

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `id` | UUID | No | Unique feedback identifier generated by database |
| `conversation_id` | UUID | No | Reference to conversation being reviewed |
| `wa_id` | string | No | WhatsApp user ID from conversation |
| `rating` | integer | Yes | Quality rating from 1 (poor) to 5 (excellent) |
| `comment` | string | Yes | Admin feedback text (max 2000 characters) |
| `is_embedded` | boolean | No | True if comment was embedded in vector database |
| `created_at` | datetime | No | Timestamp when feedback was created (ISO 8601) |
| `updated_at` | datetime | No | Timestamp when feedback was last updated (ISO 8601) |

---

## Rating Scale

| Rating | Emoji | Meaning | When to Use |
|--------|-------|---------|-------------|
| 5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | üü¢ | Perfect | Answer is accurate, region-specific, actionable |
| 4 ‚≠ê‚≠ê‚≠ê‚≠ê | üü¢ | Good | Answer is correct, minor improvements possible |
| 3 ‚≠ê‚≠ê‚≠ê | üü° | Acceptable | Answer is partially correct, needs more detail |
| 2 ‚≠ê‚≠ê | üü† | Poor | Answer is incomplete, missing key information |
| 1 ‚≠ê | üî¥ | Bad | Answer is incorrect or misleading |

**Best Practice**: Always include a comment explaining the rating, especially for ratings < 4.

---

## Comment Guidelines

### Good Comments (Embedded in Vector DB)

‚úÖ **Detailed and actionable**:
```
Le ma√Øs se plante √† Bouak√© entre avril et juin pendant la saison des pluies.
Temp√©rature id√©ale: 25-30¬∞C. Sol bien drain√© requis.
Espacement recommand√©: 75cm entre rangs, 40cm entre plants.
Vari√©t√©s adapt√©es: Early Tha√Ø, Obatanpa.
Rendement attendu: 3-4 tonnes/hectare.
```

‚úÖ **Region-specific corrections**:
```
Pour la r√©gion de Bouak√© (zone centro), les p√©riodes de plantation sont:
- Premi√®re saison: Mars-Avril
- Deuxi√®me saison: Septembre-Octobre
Sol lat√©ritique recommand√© avec apport de fumure organique.
```

‚úÖ **Improved explanations**:
```
Le mildiou du cacao se manifeste par:
1. Taches brunes sur feuilles
2. Pourriture des cabosses
3. D√©coloration des graines
Traitement: Fongicide √† base de cuivre (bouillie bordelaise) toutes les 2 semaines.
Pr√©vention: √âlagage pour a√©rer la plantation.
```

### Poor Comments (Not helpful for RAG)

‚ùå **Too vague**:
```
Bonne r√©ponse
```

‚ùå **Only rating without explanation**:
```
5/5
```

‚ùå **No context**:
```
Correct
```

---

## Embedding Process

When `embed_immediately: true` (default), the feedback comment is embedded in the vector database:

1. **Validate**: Check that comment exists and is not empty
2. **Embed**: Generate 768-dimensional vector via Supabase Edge Function
3. **Store**: Insert feedback with embedding into database
4. **Index**: HNSW index makes it immediately searchable
5. **Update**: Increment `feedback_count` and recalculate `average_rating` on conversation

**Embedding Model**: all-MiniLM-L6-v2 (sentence-transformers)
- **Dimension**: 768
- **Latency**: ~50ms
- **Cost**: $0 (Supabase Edge Function)

**Result**: Future RAG queries can retrieve this improved feedback as context, directly improving bot responses.

---

## is_embedded Flag

### True (embedded in vector DB)
- ‚úÖ Comment was successfully embedded
- ‚úÖ Available for RAG retrieval
- ‚úÖ Will improve future bot responses
- ‚úÖ Searchable via vector similarity

### False (not embedded)
- ‚ö†Ô∏è No comment provided (rating-only feedback)
- ‚ö†Ô∏è Embedding failed (network error, timeout)
- ‚ö†Ô∏è `embed_immediately: false` was set

**Recommendation**: Always set `embed_immediately: true` to maximize RAG improvement.

---

## Database Schema

```sql
CREATE TABLE feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  wa_id TEXT NOT NULL,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  embedding VECTOR(768), -- pgvector for semantic search
  is_embedded BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- Indexes
CREATE INDEX feedback_wa_id_idx ON feedback(wa_id);
CREATE INDEX feedback_conversation_id_idx ON feedback(conversation_id);
CREATE INDEX feedback_embedding_idx ON feedback USING hnsw (embedding vector_cosine_ops);
CREATE INDEX feedback_is_embedded_idx ON feedback(is_embedded);
```

### Cascade Delete
When a conversation is deleted, all associated feedback is automatically deleted via `ON DELETE CASCADE`.

---

## Validation Rules

### conversation_id
- ‚úÖ Must be valid UUID
- ‚úÖ Must reference existing conversation in database
- ‚ùå Returns 404 if conversation not found

### rating
- ‚úÖ Optional (can be null)
- ‚úÖ Must be integer between 1 and 5
- ‚ùå Returns 400 if outside range

### comment
- ‚úÖ Optional (can be null)
- ‚úÖ Maximum 2000 characters
- ‚ùå Returns 400 if too long
- ‚ö†Ô∏è Will not embed if null or empty

### embed_immediately
- ‚úÖ Optional boolean (default: true)
- ‚úÖ Only applies if comment is provided
- ‚ö†Ô∏è Set to false to skip embedding (not recommended)

---

## RAG Improvement Loop

### How Feedback Improves Bot Responses

1. **User asks**: "Quand planter le ma√Øs √† Bouak√©?"
2. **Bot responds**: Generic answer from knowledge base
3. **Admin reviews**: Conversation gets rating 3/5
4. **Admin provides feedback**:
```
Le ma√Øs se plante √† Bouak√© entre avril et juin pendant la saison des pluies.
Temp√©rature id√©ale: 25-30¬∞C. Espacement: 75cm x 40cm.
Vari√©t√©s adapt√©es: Early Tha√Ø, Obatanpa.
```
5. **Feedback is embedded**: Vector stored in database with HNSW index
6. **Next time user asks**: RAG pipeline retrieves improved feedback as context
7. **Bot responds with improved answer**: Includes region-specific details from feedback

**Result**: Bot gets smarter over time as admin reviews accumulate.

---

## Query Examples

### Submit feedback with rating and comment
```typescript
const feedback = await adminFetch('/admin/feedback', {
  method: 'POST',
  body: JSON.stringify({
    conversation_id: "550e8400-e29b-41d4-a716-446655440000",
    rating: 5,
    comment: "Excellent advice on maize planting!",
    embed_immediately: true
  })
});
```

### Submit rating-only feedback (no embedding)
```typescript
const feedback = await adminFetch('/admin/feedback', {
  method: 'POST',
  body: JSON.stringify({
    conversation_id: "550e8400-e29b-41d4-a716-446655440000",
    rating: 4
  })
});
```

### Get all feedback for a user
```typescript
const response = await adminFetch('/admin/feedback?wa_id=1234567890');
```

### Get high-rated feedback only
```typescript
const response = await adminFetch('/admin/feedback?min_rating=4&limit=50');
```

---

## Best Practices

### Rating Guidelines
- ‚úÖ Always provide both rating AND comment
- ‚úÖ Use rating 5 for perfect, actionable answers
- ‚úÖ Use rating 1-2 for incorrect/misleading answers
- ‚úÖ Explain why you gave the rating

### Comment Quality
- ‚úÖ Be specific and detailed (100-500 words ideal)
- ‚úÖ Include region-specific information
- ‚úÖ Provide actionable recommendations
- ‚úÖ Include numbers, measurements, timing
- ‚úÖ Cite sources if available
- ‚ùå Avoid vague comments like "good" or "ok"
- ‚ùå Don't just rephrase bot's answer

### Embedding Strategy
- ‚úÖ Always set `embed_immediately: true` (default)
- ‚úÖ Embed all substantive comments
- ‚úÖ Only skip embedding for rating-only feedback
- ‚ö†Ô∏è Monitor `is_embedded: false` entries for failures

### Workflow
1. Review conversation via GET /admin/conversations/:id
2. Evaluate bot response quality (1-5 rating)
3. Write detailed feedback comment
4. Submit via POST /admin/feedback with `embed_immediately: true`
5. Verify `is_embedded: true` in response
6. Repeat for low-rated conversations

---

## Statistics Queries

### Count embedded vs non-embedded feedback
```typescript
const allFeedback = await adminFetch('/admin/feedback?limit=1000');
const embedded = allFeedback.feedback.filter(f => f.is_embedded).length;
const total = allFeedback.feedback.length;

console.log(`Embedded: ${embedded}/${total} (${(embedded/total*100).toFixed(1)}%)`);
```

### Average rating across all feedback
```typescript
const allFeedback = await adminFetch('/admin/feedback?limit=1000');
const ratings = allFeedback.feedback.filter(f => f.rating !== null).map(f => f.rating!);
const avgRating = ratings.reduce((a, b) => a + b, 0) / ratings.length;

console.log(`Average rating: ${avgRating.toFixed(2)}/5.00`);
```

### Find feedback needing embedding
```typescript
const allFeedback = await adminFetch('/admin/feedback?limit=1000');
const needsEmbedding = allFeedback.feedback.filter(
  f => f.comment && !f.is_embedded
);

console.log(`${needsEmbedding.length} feedback entries need embedding`);
```

---

## Related Schemas

- [Conversation Schema](./conversation.md) - Conversations that feedback references
- [Knowledge Schema](./knowledge.md) - RAG document database structure
- [Translation Schema](./translation.md) - Multilingual translation database

---

## Error Handling

### 404 Not Found
```json
{
  "error": "Conversation not found"
}
```
**Cause**: `conversation_id` does not exist in database

### 400 Bad Request
```json
{
  "error": "Validation failed",
  "message": "comment must be 2000 characters or less"
}
```
**Cause**: Comment too long

### 400 Bad Request
```json
{
  "error": "Validation failed",
  "message": "rating must be between 1 and 5"
}
```
**Cause**: Invalid rating value

---

## Performance

- **Embedding latency**: ~50ms (Supabase Edge Function)
- **Insert latency**: ~20ms (PostgreSQL)
- **Total POST latency**: ~100ms
- **GET query latency**: ~30ms (indexed queries)

**Tip**: Submit feedback in batches of 10-20 to avoid rate limiting.
