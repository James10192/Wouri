# Translation Schema

Data structure for multilingual translation database (Français, Dioula, Baoulé).

---

## Base Translation Object

```typescript
interface Translation {
  id: string;                    // UUID - Unique translation identifier
  source_text: string;           // Source text (1-1000 chars)
  source_language: Language;     // Source language code
  target_language: Language;     // Target language code
  translated_text: string;       // Translation (1-1000 chars)
  context: string | null;        // Context hint (max 500 chars)
  verified: boolean;             // True if verified by native speaker
  created_by: string | null;     // Creator identifier (e.g., "admin")
  created_at: string;            // ISO 8601 timestamp
  updated_at: string;            // ISO 8601 timestamp
}

type Language = "fr" | "dioula" | "baoulé" | "en";
```

## TypeScript Types

```typescript
// Zod schema for validation
import { z } from "zod";

export const languageSchema = z.enum(["fr", "dioula", "baoulé", "en"]);

export const translationSchema = z.object({
  id: z.string().uuid(),
  source_text: z.string().min(1).max(1000),
  source_language: languageSchema,
  target_language: languageSchema,
  translated_text: z.string().min(1).max(1000),
  context: z.string().max(500).nullable(),
  verified: z.boolean().default(false),
  created_by: z.string().nullable(),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime(),
});

export type Translation = z.infer<typeof translationSchema>;

// Create translation request
export const translationCreateSchema = z.object({
  source_text: z.string().min(1).max(1000),
  source_language: languageSchema,
  target_language: languageSchema,
  translated_text: z.string().min(1).max(1000),
  context: z.string().max(500).optional(),
  verified: z.boolean().default(false),
}).refine(
  data => data.source_language !== data.target_language,
  {
    message: "source_language and target_language must be different"
  }
);

export type TranslationCreate = z.infer<typeof translationCreateSchema>;
```

---

## Example Translation Object

```json
{
  "id": "bb0e8400-e29b-41d4-a716-446655440000",
  "source_text": "Quand planter le maïs?",
  "source_language": "fr",
  "target_language": "dioula",
  "translated_text": "Kaba suman ka sɔrɔ?",
  "context": "agriculture",
  "verified": true,
  "created_by": "admin",
  "created_at": "2026-01-10T15:00:00Z",
  "updated_at": "2026-01-10T15:00:00Z"
}
```

---

## Translation List Response

### With Query (Full-Text Search)

```typescript
interface TranslationSearchResult extends Translation {
  relevance: number;  // Full-text search relevance score (0-1)
}

interface TranslationSearchResponse {
  translations: TranslationSearchResult[];
}
```

**Example**:
```json
{
  "translations": [
    {
      "id": "bb0e8400-e29b-41d4-a716-446655440000",
      "source_text": "maïs",
      "source_language": "fr",
      "target_language": "dioula",
      "translated_text": "kaba",
      "context": "crop name",
      "verified": true,
      "relevance": 0.95
    },
    {
      "id": "cc0e8400-e29b-41d4-a716-446655440000",
      "source_text": "plantation de maïs",
      "source_language": "fr",
      "target_language": "dioula",
      "translated_text": "kaba suman",
      "context": "agriculture",
      "verified": true,
      "relevance": 0.88
    }
  ]
}
```

### Without Query (Simple Filtering)

```typescript
interface TranslationListResponse {
  translations: Translation[];
}
```

**Example**:
```json
{
  "translations": [
    {
      "id": "bb0e8400-e29b-41d4-a716-446655440000",
      "source_text": "maïs",
      "source_language": "fr",
      "target_language": "dioula",
      "translated_text": "kaba",
      "context": "crop name",
      "verified": true,
      "created_by": "admin",
      "created_at": "2026-01-10T15:00:00Z",
      "updated_at": "2026-01-10T15:00:00Z"
    }
  ]
}
```

---

## Field Descriptions

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `id` | UUID | No | Unique translation identifier generated by database |
| `source_text` | string | No | Original text in source language (1-1000 chars) |
| `source_language` | enum | No | Source language: fr, dioula, baoulé, en |
| `target_language` | enum | No | Target language: fr, dioula, baoulé, en |
| `translated_text` | string | No | Translation in target language (1-1000 chars) |
| `context` | string | Yes | Context hint (max 500 chars) - e.g., "agriculture", "crop name" |
| `verified` | boolean | No | True if verified by native speaker (default: false) |
| `created_by` | string | Yes | Creator identifier (e.g., "admin", "user@example.com") |
| `created_at` | datetime | No | Timestamp when translation was created (ISO 8601) |
| `updated_at` | datetime | No | Timestamp when translation was last updated (ISO 8601) |

---

## Language Codes

### Supported Languages

| Language | Code | Speakers in CI | Notes |
|----------|------|----------------|-------|
| **Français** | `fr` | ~10M (official) | Standard French |
| **Dioula** | `dioula` | ~5M (north) | Bambara variant spoken in CI |
| **Baoulé** | `baoulé` | ~4M (center) | Akan language of CI |
| **English** | `en` | Limited | For documentation only |

### Language Pair Examples

✅ **Valid language pairs**:
- `fr` → `dioula` (French to Dioula)
- `fr` → `baoulé` (French to Baoulé)
- `dioula` → `fr` (Dioula to French)
- `baoulé` → `fr` (Baoulé to French)
- `en` → `fr` (English to French)

❌ **Invalid language pairs**:
- `fr` → `fr` (same language)
- `dioula` → `dioula` (same language)

**Note**: The database enforces that `source_language ≠ target_language`.

---

## Unique Constraint

The database enforces a unique constraint on `(source_text, source_language, target_language)`.

### Allowed
✅ "maïs" (fr → dioula) + "maïs" (fr → baoulé)
✅ "maïs" (fr → dioula) + "kaba" (dioula → fr)
✅ "maïs" (fr → en) + "corn" (en → fr)

### Not Allowed
❌ Duplicate "maïs" (fr → dioula)
❌ Duplicate "kaba" (dioula → fr)

**Reason**: Prevents duplicate translations for the same text and language pair.

### Conflict Handling

**409 Conflict** response when attempting to add duplicate:
```json
{
  "error": "Translation already exists",
  "message": "Translation from fr to dioula already exists for this text"
}
```

---

## Context Field

The `context` field provides hints about the usage context to disambiguate translations.

### Context Categories

| Context | Description | Example |
|---------|-------------|---------|
| `crop` | Crop name | "maïs" → "kaba" |
| `action` | Agricultural action | "planter" → "suman" |
| `season` | Season/timing | "saison des pluies" → "sànji tuma" |
| `tool` | Tool/equipment | "houe" → "daba" |
| `disease` | Plant disease | "mildiou" → "bana" |
| `measurement` | Unit/measurement | "hectare" → "hɛktar" |
| `number` | Number/quantity | "dix" → "tan" |
| `greeting` | Greeting phrase | "bonjour" → "i ni sɔgɔma" |

### Context Best Practices

✅ **Good context usage**:
```json
{
  "source_text": "plant",
  "source_language": "en",
  "target_language": "fr",
  "translated_text": "plante",
  "context": "noun - botanical organism"
}

{
  "source_text": "plant",
  "source_language": "en",
  "target_language": "fr",
  "translated_text": "planter",
  "context": "verb - to sow seeds"
}
```

❌ **Poor context usage**:
```json
{
  "source_text": "maïs",
  "source_language": "fr",
  "target_language": "dioula",
  "translated_text": "kaba",
  "context": null  // Missing context
}
```

---

## Verification Status

### verified: true
- ✅ Translation reviewed by native speaker
- ✅ Culturally appropriate
- ✅ Commonly used term
- ✅ High confidence

### verified: false
- ⚠️ Machine-translated or unverified
- ⚠️ Needs review by native speaker
- ⚠️ May not be commonly used
- ⚠️ Lower confidence

**Recommendation**: Only use `verified: true` translations in production bot responses.

---

## Database Schema

```sql
CREATE TABLE translations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_text TEXT NOT NULL CHECK (char_length(source_text) >= 1 AND char_length(source_text) <= 1000),
  source_language TEXT NOT NULL CHECK (source_language IN ('fr', 'dioula', 'baoulé', 'en')),
  target_language TEXT NOT NULL CHECK (target_language IN ('fr', 'dioula', 'baoulé', 'en')),
  translated_text TEXT NOT NULL CHECK (char_length(translated_text) >= 1 AND char_length(translated_text) <= 1000),
  context TEXT CHECK (char_length(context) <= 500),
  verified BOOLEAN DEFAULT FALSE NOT NULL,
  created_by TEXT,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_translation UNIQUE (source_text, source_language, target_language),
  CONSTRAINT different_languages CHECK (source_language != target_language)
);

-- Indexes
CREATE INDEX translations_lookup_idx ON translations(source_language, target_language);
CREATE INDEX translations_verified_idx ON translations(verified);
CREATE INDEX translations_source_text_idx ON translations USING gin (to_tsvector('french', source_text));
```

---

## Full-Text Search

When `query` parameter is provided, the API uses PostgreSQL full-text search with `relevance` scoring.

### Search Process

1. **Tokenize**: Split query into terms
2. **Match**: Find translations where `source_text` contains terms
3. **Rank**: Calculate relevance score using `ts_rank`
4. **Sort**: Order by relevance (descending)

### Relevance Score

| Score | Interpretation |
|-------|----------------|
| > 0.9 | Exact match |
| 0.7 - 0.9 | Very relevant |
| 0.5 - 0.7 | Somewhat relevant |
| < 0.5 | Weak match |

### Example Search

```typescript
// Search for "maïs" in source text
const results = await adminFetch('/admin/translations?query=maïs&limit=10');

results.translations.forEach(t => {
  console.log(`${t.source_text} (${t.source_language}) → ${t.translated_text} (${t.target_language})`);
  console.log(`Relevance: ${t.relevance}`);
});
```

---

## Validation Rules

### source_text & translated_text
- ✅ Required, non-empty string
- ✅ Minimum 1 character
- ✅ Maximum 1000 characters
- ❌ Returns 400 if outside range

### source_language & target_language
- ✅ Required
- ✅ Must be one of: fr, dioula, baoulé, en
- ✅ Must be different from each other
- ❌ Returns 400 if invalid or same

### context
- ✅ Optional
- ✅ Maximum 500 characters
- ❌ Returns 400 if too long

### verified
- ✅ Optional boolean (default: false)
- ✅ Set to true only after native speaker verification

---

## Query Examples

### Add basic translation
```typescript
const translation = await adminFetch('/admin/translations', {
  method: 'POST',
  body: JSON.stringify({
    source_text: "maïs",
    source_language: "fr",
    target_language: "dioula",
    translated_text: "kaba",
    context: "crop name",
    verified: true
  })
});
```

### Add translation with creator
```typescript
const translation = await adminFetch('/admin/translations', {
  method: 'POST',
  body: JSON.stringify({
    source_text: "Quand planter le maïs?",
    source_language: "fr",
    target_language: "dioula",
    translated_text: "Kaba suman ka sɔrɔ?",
    context: "agriculture question",
    verified: true,
    created_by: "admin@wouribot.ci"
  })
});
```

### Search translations
```typescript
// Full-text search
const results = await adminFetch('/admin/translations?query=maïs&limit=10');
```

### Filter by language pair
```typescript
// Get all French to Dioula translations
const frToDioula = await adminFetch(
  '/admin/translations?source_language=fr&target_language=dioula&limit=100'
);
```

### Get verified translations only
```typescript
const verified = await adminFetch('/admin/translations?verified_only=true&limit=100');
```

---

## Use Cases

### 1. Bulk Import Translations

```typescript
const translations = [
  {
    source_text: "maïs",
    source_language: "fr",
    target_language: "dioula",
    translated_text: "kaba",
    context: "crop",
    verified: true
  },
  {
    source_text: "manioc",
    source_language: "fr",
    target_language: "dioula",
    translated_text: "banan",
    context: "crop",
    verified: true
  },
  {
    source_text: "cacao",
    source_language: "fr",
    target_language: "dioula",
    translated_text: "kakao",
    context: "crop",
    verified: true
  }
];

for (const t of translations) {
  try {
    await adminFetch('/admin/translations', {
      method: 'POST',
      body: JSON.stringify(t)
    });
    console.log(`✅ Added: ${t.source_text} → ${t.translated_text}`);
  } catch (error) {
    console.error(`❌ Failed: ${t.source_text}`, error.message);
  }
}
```

### 2. Translation Coverage Report

```typescript
const languages = ['fr', 'dioula', 'baoulé'];

for (const source of languages) {
  for (const target of languages) {
    if (source === target) continue;

    const translations = await adminFetch(
      `/admin/translations?source_language=${source}&target_language=${target}&limit=1000`
    );

    console.log(`${source} → ${target}: ${translations.translations.length} translations`);
  }
}

// Output:
// fr → dioula: 45 translations
// fr → baoulé: 32 translations
// dioula → fr: 45 translations
// baoulé → fr: 32 translations
```

### 3. Find Missing Translations

```typescript
// Core agricultural terms
const coreTerms = ["maïs", "manioc", "cacao", "plantation", "récolte", "engrais"];

for (const term of coreTerms) {
  // Check French → Dioula
  const frToDioula = await adminFetch(
    `/admin/translations?query=${term}&source_language=fr&target_language=dioula`
  );

  if (frToDioula.translations.length === 0) {
    console.warn(`⚠️ Missing FR→Dioula: ${term}`);
  }

  // Check French → Baoulé
  const frToBaoule = await adminFetch(
    `/admin/translations?query=${term}&source_language=fr&target_language=baoulé`
  );

  if (frToBaoule.translations.length === 0) {
    console.warn(`⚠️ Missing FR→Baoulé: ${term}`);
  }
}
```

---

## Translation Quality Guidelines

### Good Translations

✅ **Culturally appropriate**:
```json
{
  "source_text": "bonjour",
  "source_language": "fr",
  "target_language": "dioula",
  "translated_text": "i ni sɔgɔma",
  "context": "morning greeting",
  "verified": true
}
```

✅ **Common usage**:
```json
{
  "source_text": "maïs",
  "source_language": "fr",
  "target_language": "dioula",
  "translated_text": "kaba",
  "context": "crop name",
  "verified": true
}
```

✅ **Context-aware**:
```json
{
  "source_text": "planter",
  "source_language": "fr",
  "target_language": "dioula",
  "translated_text": "suman",
  "context": "action - to sow seeds",
  "verified": true
}
```

### Poor Translations

❌ **Direct word-for-word** (no cultural adaptation):
```json
{
  "source_text": "bonjour",
  "source_language": "fr",
  "target_language": "dioula",
  "translated_text": "bon jour",  // Not appropriate!
  "verified": false
}
```

❌ **No context**:
```json
{
  "source_text": "plant",
  "source_language": "en",
  "target_language": "fr",
  "translated_text": "plante",  // Could be noun or verb!
  "context": null,
  "verified": false
}
```

---

## Related Schemas

- [Conversation Schema](./conversation.md) - Conversations use translations for multilingual support
- [Feedback Schema](./feedback.md) - Feedback may include translation improvements
- [Knowledge Schema](./knowledge.md) - Knowledge base documents support multilingual content

---

## Error Handling

### 409 Conflict
```json
{
  "error": "Translation already exists",
  "message": "Translation from fr to dioula already exists for this text"
}
```
**Cause**: Duplicate translation for same `(source_text, source_language, target_language)`

### 400 Bad Request
```json
{
  "error": "Validation failed",
  "message": "source_language and target_language must be different"
}
```
**Cause**: Same language for source and target

### 400 Bad Request
```json
{
  "error": "Validation failed",
  "message": "source_text must be between 1 and 1000 characters"
}
```
**Cause**: Text too long or empty

---

## Best Practices

### Creating Translations
- ✅ Always include context for ambiguous terms
- ✅ Set verified: true only after native speaker review
- ✅ Add created_by for accountability
- ✅ Use common, widely-understood terms
- ✅ Test translations with native speakers
- ❌ Don't use machine translations without verification
- ❌ Don't add duplicate entries

### Managing Translations
- ✅ Track verification status
- ✅ Review and update unverified translations
- ✅ Monitor translation coverage across language pairs
- ✅ Identify and fill missing translations for core terms

### Quality Control
- ✅ Require native speaker verification before marking verified: true
- ✅ Test translations in real conversations
- ✅ Gather user feedback on translation quality
- ✅ Update translations based on usage patterns
